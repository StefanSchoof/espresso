parameters:
  environment: test
  sshEndpoint: dockerhost
  test: false
  containerPool: Hosted Ubuntu 1604
  dockerTag: dev
  testingCmd: echo

jobs:
- job: deploy
  pool: Hosted Ubuntu 1604
  variables:
    KEYVAULTNAME: 'espresso-global'
    RELEASE_ENVIRONMENTNAME: ${{ parameters.environment }}
  steps:
  - checkout: none
  - task: DownloadPipelineArtifact@2
    inputs:
      artifactName: deploy
      path: deploy
  - task: DownloadPipelineArtifact@2
    inputs:
      artifactName: web
      path: web
  - task: DownloadPipelineArtifact@2
    inputs:
      artifactName: func
      path: func
  - task: Docker@1
    displayName: pull
    inputs:
      containerregistrytype: 'Container Registry'
      dockerRegistryEndpoint: 'docker hub sschoof'
      command: pull
      arguments: 'stefanschoof/espresso:build$(Build.BuildId)'
  - bash: 'docker tag stefanschoof/espresso:build$(Build.BuildId) stefanschoof/espresso:${{ parameters.dockerTag }}'
    displayName: 'Tag image'
  - task: Docker@1
    displayName: 'Push an image'
    inputs:
      containerregistrytype: 'Container Registry'
      dockerRegistryEndpoint: 'docker hub sschoof'
      command: 'Push an image'
      imageName: 'stefanschoof/espresso:${{ parameters.dockerTag }}'
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: $(TERRAFORM_VERSION)
  - task: TerraformTaskV1@0
    displayName: 'Terraform init'
    inputs:
      workingDirectory: deploy
      backendServiceArm: 'Visual Studio Premium mit MSDN'
      backendAzureRmResourceGroupName: espresso-tfstate
      backendAzureRmStorageAccountName: espressotfstate
      backendAzureRmContainerName: tfstate
      backendAzureRmKey: terraform.tfstate
  - task: TerraformTaskV1@0
    displayName: 'Terraform apply'
    inputs:
      command: apply
      workingDirectory: deploy
      environmentServiceNameAzureRM: 'Visual Studio Premium mit MSDN'
    env:
      TF_WORKSPACE: ${{ parameters.environment }}
  - task: AzureCLI@1
    displayName: 'Infrastructure as Code'
    inputs:
      azureSubscription: 'Visual Studio Premium mit MSDN'
      scriptPath: 'deploy/iac.sh'
      workingDirectory: 'deploy'
      addSpnToEnvironment: true
  - task: AzureCLI@1
    displayName: 'Deploy'
    inputs:
      azureSubscription: 'Visual Studio Premium mit MSDN'
      scriptPath: 'deploy/deploy.sh'
      workingDirectory: 'deploy'
      addSpnToEnvironment: true
- job: container
  dependsOn: deploy
  pool: ${{ parameters.containerPool }}
  steps:
  - checkout: none
  - task: DownloadPipelineArtifact@2
    inputs:
      artifactName: node
      path: .
  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: espresso-global'
    inputs:
      azureSubscription: 'Visual Studio Premium mit MSDN'
      KeyVaultName: 'espresso-global'
  - task: CopyFilesOverSSH@0
    displayName: 'Securely copy files to the remote machine'
    inputs:
      sshEndpoint: ${{ parameters.sshEndpoint }}
      contents: 'docker-compose.yml'
      targetFolder: espresso
  - task: SSH@0
    displayName: 'Update docker'
    inputs:
      sshEndpoint: ${{ parameters.sshEndpoint }}
      runOptions: script
      scriptPath: 'pideploy.sh'
      args: '"$(DeviceConnectionString)" "$(NodeInstrumentationKey)" "$(Build.BuildId)" "${{ parameters.testingCmd }}"'
- ${{ if eq(parameters.test, 'true') }}:
  - job: e2etest
    pool: Hosted VS2017
    dependsOn: container
    steps:
    - checkout: none
    - task: DownloadPipelineArtifact@2
      inputs:
        artifactName: e2etest
        path: .
    - task: AzureKeyVault@1
      displayName: 'Azure Key Vault: espresso-global'
      inputs:
        azureSubscription: 'Visual Studio Premium mit MSDN'
        KeyVaultName: 'espresso-global'
    - task: Npm@1
      displayName: 'npm ci --production'
      inputs:
        command: custom
        customCommand: 'ci --production'
    - task: Npm@1
      displayName: e2etest
      inputs:
        command: custom
        customCommand: start
    - task: PublishTestResults@2
      displayName: 'Publish Test Results **/junit.xml'
      inputs:
        testResultsFiles: 'junit.xml'
      condition: succeededOrFailed()
  - job: destroy
    dependsOn: e2etest
    pool: Hosted Ubuntu 1604
    steps:
    - checkout: none
    - task: DownloadPipelineArtifact@2
      inputs:
        artifactName: deploy
        path: .
    - task: TerraformInstaller@0
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: $(TERRAFORM_VERSION)
    - task: AzureCLI@1
      displayName: 'destroy'
      inputs:
        azureSubscription: 'Visual Studio Premium mit MSDN'
        scriptPath: 'destroy.sh'
        addSpnToEnvironment: true
